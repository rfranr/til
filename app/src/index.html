<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TIL Index</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem}
  .filters{display:flex;gap:1rem;flex-wrap:wrap;margin:.5rem 0 1rem}
  .tag{cursor:pointer;border:1px solid #ddd;border-radius:999px;padding:.25rem .6rem;font-size:.9rem}
  .tag.active{background:#eee}
  .card{border:1px solid #eee;border-radius:12px;padding:1rem;margin:.75rem 0}
  .muted{color:#666;font-size:.9rem}
  input[type="search"]{width:100%;padding:.6rem;border-radius:8px;border:1px solid #ddd}
</style>
<h1>Today I Learned</h1>
<input id="q" type="search" placeholder="Search title, excerpt or #tagâ€¦" autofocus />
<div class="filters" id="filters"></div>
<div id="list" aria-live="polite"></div>

<script>
(async () => {
  const res = await fetch("index.json", { cache: "no-store" });
  const data = await res.json();
  const list = document.getElementById("list");
  const q = document.getElementById("q");
  const filters = document.getElementById("filters");

  const allTags = Array.from(new Set(data.flatMap(i => i.tags))).sort();
  const activeTags = new Set();

  const renderTags = () => {
    filters.innerHTML = "";
    allTags.forEach(t => {
      const b = document.createElement("button");
      b.textContent = `#${t}`;
      b.className = "tag" + (activeTags.has(t) ? " active" : "");
      b.onclick = () => { activeTags.has(t) ? activeTags.delete(t) : activeTags.add(t); render(); renderTags(); };
      filters.appendChild(b);
    });
  };

  const matches = (item, term) => {
    const hay = [item.title, item.excerpt, ...(item.tags||[])].join(" ").toLowerCase();
    return hay.includes(term);
  };

  function render() {
    const term = q.value.trim().toLowerCase();
    const byTag = (item) => activeTags.size === 0 || item.tags?.some(t => activeTags.has(t));
    const rows = data.filter(i => byTag(i) && (term ? matches(i, term) : true));
    list.innerHTML = rows.map(i => `
      <article class="card">
        <a href="/${i.url}"><h3>${i.title}</h3></a>
        <div class="muted">${i.date ?? ""} ${i.tags?.map(t=>`<span class="tag">#${t}</span>`).join(" ")}</div>
        <p>${i.excerpt}</p>
      </article>
    `).join("") || "<p class='muted'>No results.</p>";
  }

  q.addEventListener("input", render);
  renderTags(); render();
})();

</script>
</html>
